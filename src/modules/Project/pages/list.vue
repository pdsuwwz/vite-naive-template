<template>
  <LayoutArea>
    <template #top>
      <NavigationNavBar
        :fixed="false"
      >
        <NavigationSideLogo />
      </NavigationNavBar>
    </template>

    <template #side>
      <LayoutSection title="项目管理">
        <n-button
          type="primary"
          class="create-action"
          @click="handleCreateProject()"
        >
          <template #icon>
            <n-icon>
              <div class="i-material-symbols:new-window-sharp"></div>
            </n-icon>
          </template>
          创建项目
        </n-button>
      </LayoutSection>
    </template>

    <template #content>
      <LayoutSection
        has-divider
        flex-content
      >
        <template #head>
          <n-date-picker type="datetimerange">
            <template #footer>
              extra footer
            </template>
          </n-date-picker>
        </template>

        <ProjectTableHeader />
        <ProjectTableBody />
      </LayoutSection>
    </template>
  </LayoutArea>
</template>

<script setup lang="ts">
import NavigationSideLogo from '@/components/Navigation/Side/SideLogo.vue'
import NavigationNavBar from '@/components/Navigation/NavBar.vue'

import ProjectForm from '@/modules/Project/components/ProjectForm.vue'
import ProjectTableHeader from '@/modules/Project/components/TableHeader.vue'
import ProjectTableBody from '@/modules/Project/components/TableBody.vue'

import { useProjectStore } from '@/modules/Project/store'

defineOptions({
  name: 'ProjectList'
})

const { proxy } = useCurrentInstance()
const projectStore = useProjectStore()

const testRef = ref()

async function handleCreateProject () {

  const formData = reactive({
    name: '',
    corpName: '',
    notes: ''
  })

  await nextTick()
  const dd = window.$ModalDialog.create({
    title: '创建项目',
    style: {
      // top: '10vh',
      width: '50vw'
    },
    closable: true,
    maskClosable: false,
    closeOnEsc: false,
    content: () => h(ProjectForm, {
      modelValue: formData,
      ref: testRef
    }),
    positiveText: '创建',
    async onPositiveClick () {
      const isValid = await testRef.value.validateRules()
      if (!isValid) return Promise.reject(new Error(''))

      dd.loading = true
      const { error, data } = await projectStore.createProject(formData)

      dd.loading = false

      if (error) {
        return Promise.reject(new Error(''))
      }

      console.log(data!.createTime)

      projectStore.getProjectList()
    }
  })
}

function handleSelectSearch (name?: string) {
  console.log('搜索项目名: ', name)
  projectStore.getProjectList({
    kw: name
  })
}
handleSelectSearch()
</script>

<style lang="scss" scoped>
.create-action {
  padding: 10px 20px;
  width: 100%;
  font-weight: 600;
}
</style>
